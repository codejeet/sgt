# Changelog

## Unreleased

- Triage follow-up for blocker PR `#161`: confirmed both deltas are superseded on `master` (queue-field quoting now handled by the temp-file `%q` writer path plus parse hardening in `#170`; inconclusive-review behavior superseded by refinery fallback flow from `#167/#169` with follow-up in `#172`), and closed `#161` as superseded to unblock `#173`.
- Mayor orphan-PR queueing now live-revalidates PR state (`OPEN` required) immediately before queueing; stale open-list snapshots that already became `MERGED`/`CLOSED` are skipped with explicit reason logging (`MAYOR_ORPHAN_SKIP_STALE`).
- Added regression coverage for stale orphan PR snapshot false-positives in `test_mayor_orphan_stale_snapshot_guard.sh`.
- Mayor side-effect decisions (`dispatch`, `nuke`, `merge`) now require an immediate post-action live verification receipt before success is declared, with durable structured receipt fields (`action`, `target`, `expected_state`, `observed_state`, `verified_at`) under `~/.sgt/mayor-action-receipts/`.
- Receipt mismatches now append explicit non-success decision-log entries with retry/no-op hints, and replayed action keys suppress conflicting success receipts (`reason=replayed-action-key-existing-success`).
- Added `sgt mayor merge <pr#> --repo <repo>` so mayor merge actions run through the same receipt fence and live verification path.
- Added regression coverage for dispatch post-action drift and replayed merge action-key behavior in `test_mayor_action_receipt_fence.sh` (wired into `test_mayor_wake_replay_regression.sh`).
- Mayor dispatch hardening: added a pre-dispatch live revalidation guard to `sgt sling` (mayor context) that atomically checks for open PRs and open `sgt-authorized` issues before issue creation.
- Mayor decision flow now skips dispatch when revalidation is dirty/stale and logs a clear reason in both terminal output and `~/.sgt/mayor-decisions.log`.
- Added regression coverage for stale snapshot races and no-duplicate dispatch behavior in `test_mayor_stale_dispatch_race.sh`.
- Mayor merge-queue snapshot freshness guard now performs one live revalidation pass before surfacing active issues in mayor `CLAUDE.md`; when stale and live diverge, live state deterministically wins and stale snapshot details are recorded in decision output.
- Mayor now emits explicit snapshot guard status lines containing `snapshot`, `live`, `chosen`, `source`, and `status` values for merge-queue decisions.
- Added regression coverage for stale-vs-live precedence in both directions (`stale=1/live=0`, `stale=0/live=1`) in `test_mayor_snapshot_freshness_guard.sh`.
- Mayor decision-log appends now use a lock + `fsync` durability path and route wake-dedupe skip logging through the same hardened append helper.
- Decision-log write failures are now non-fatal in mayor cycles, emit structured warning metadata, surface in `sgt status`, and notify Rigger at most once per cooldown window (`SGT_MAYOR_DECISION_LOG_ALERT_COOLDOWN`).
- Added/expanded regression coverage for concurrent mayor decision-log appends plus simulated write-error warning/notify cooldown behavior in `test_mayor_decision_log_durability.sh`.
- Mayor merged-trigger dispatch idempotency logs now include structured duplicate-skip context (`reason_code`, `skip_reason`, `trigger_event_key`, `repo`, `pr`, `issue`, `merged_head`, `key`) to make replay diagnostics deterministic.
- Expanded mayor post-merge dispatch fence regression coverage for rapid duplicate trigger bursts plus restart replay in `test_mayor_post_merge_dispatch_fence.sh`.
- Added a restart-safe mayor dispatch-start verification fence: mayor-tagged dispatches now write durable `repo+issue+trigger` attempt records under `~/.sgt/mayor-dispatch-attempts/` and replay verification across restarts.
- Verification now enforces bounded timeout telemetry (`MAYOR_DISPATCH_VERIFY_TIMEOUT`) and a single idempotent retry path with explicit terminal reasons (`retry-dispatch-failed`, `retry-title-lookup-failed`, `retry-budget-exhausted`) and no duplicate active work.
- Added regression coverage for verifier success, timeout, restart replay, and duplicate-trigger suppression in `test_mayor_dispatch_start_verification_fence.sh` (wired into `test_mayor_wake_replay_regression.sh`).
- Mayor now runs a stalled refinery review watchdog: PR queue items stuck in `REVIEW_UNCLEAR` past `SGT_MAYOR_REVIEW_UNCLEAR_STALE_SECS` trigger one escalated notify per PR review-state transition, with age surfaced in `sgt status`.
- Added regression coverage for watchdog threshold boundary and transition dedupe in `test_mayor_review_watchdog.sh` (wired into `test_mayor_wake_replay_regression.sh`).
- Added witness/refinery heartbeat watchdog coverage for stuck-but-running agent loops: mayor now escalates stale heartbeat incidents with exact `stale_seconds` + `last_heartbeat`, deduped once per agent per configurable window (`SGT_AGENT_HEARTBEAT_STALE_SECS`, `SGT_MAYOR_AGENT_HEARTBEAT_DEDUPE_SECS`) and reset on recovery.
- Added regression coverage for heartbeat watchdog dedupe-window behavior and recovery reset in `test_mayor_agent_heartbeat_watchdog.sh` (wired into `test_mayor_wake_replay_regression.sh`).
- Refinery merge processing now retries transient `gh pr merge` failures with bounded attempts + jitter (`SGT_REFINERY_MERGE_MAX_ATTEMPTS`, `SGT_REFINERY_MERGE_RETRY_BASE_MS`, `SGT_REFINERY_MERGE_RETRY_JITTER_MS`), revalidates PR open/head state before each retry, and emits structured final-failure notify metadata including attempts/error class.
- Added refinery merge resilience regression coverage for transient-then-success and retry-time head-drift skip paths in `test_refinery_merge_retry_resilience.sh`.
- Refinery merge attempts now claim an idempotency key (`repo+PR+head SHA`) so duplicate PR-ready queue replays for the same head are explicitly skipped before merge/conflict/reject side effects run.
- Duplicate replay skips now emit explicit status output (`duplicate event ignored`) and structured activity log events (`REFINERY_DUPLICATE_SKIP ... key="owner/repo|pr=<n>|head=<sha>"`).
- Added regression coverage for duplicate PR-ready queue replay dedupe in `test_refinery_pr_ready_dedupe.sh` (also wired into `test_mayor_wake_replay_regression.sh`).
- Hardened refinery merge idempotency fence: merge-attempt key claims are now atomic and duplicate skips include a structured `reason_code=duplicate-merge-attempt-key`.
- Merge-attempt keys are now durable once merge is attempted, preventing duplicate merge actions for the same `repo+PR+head SHA` across retries, cycles, and refinery restarts.
- Added restart replay regression coverage in `test_refinery_merge_attempt_restart_replay.sh` and wired it into `test_mayor_wake_replay_regression.sh`.
- Refinery merge hardening now captures reviewed head SHA, then performs an immediate pre-merge stale-head revalidation; when head changed after review, merge aborts with explicit operator output and structured `REFINERY_PREMERGE_SKIP ... reason_code=stale-reviewed-head` telemetry.
- Expanded `test_refinery_stale_queue_item.sh` to cover both stale-head race (skip) and normal flow (merge) with reviewed-head guard call sequencing.
- Refinery review-ready durability fence now persists `REVIEWED_HEAD_SHA` and `REVIEWED_AT` in merge-queue records before merge attempts, blocks replayed `REVIEW_APPROVED` candidates missing reviewed-head evidence with `REFINERY_MERGE_BLOCKED_MISSING_REVIEW_SHA`, and resets them to `REVIEW_PENDING` for fresh revalidation.
- Added restart/replay missing-evidence regression coverage in `test_refinery_missing_review_evidence_replay.sh` and wired it into `test_mayor_wake_replay_regression.sh`.
- Refinery `REVIEW_UNCLEAR` handling now enforces a deterministic cap fallback gate: saturated unclear retries only auto-transition into controlled merge flow when checks are green, mergeable is `MERGEABLE`, and unclear class is fallback-safe.
- Unclear-review telemetry now includes structured classification (`empty-output`, `review-timeout`, `missing-structured-verdict`, etc.) and fallback decision fields (`eligible`, `reason_code`, `check_class`, `mergeable`, `unclear_class`).
- Non-eligible saturated unclear states now emit explicit terminal hold reason codes instead of opaque saturation loops.
- Pre-merge stale-head and mergeability drift now trigger review resync (`REVIEW_PENDING` + cleared reviewed-head evidence) to avoid stale re-loop deadlocks.
- Added regression coverage for unclear fallback allow/deny paths plus stale-head resync in `test_refinery_unclear_fallback_policy.sh`, and updated stale-head assertions in `test_refinery_stale_queue_item.sh`.
- Refinery conflict auto-resolution now also triggers when conflicts appear during pre-merge revalidation or at merge-command time (including REVIEW_UNCLEAR fallback merges), instead of falling through to generic merge-failed/manual paths.
- Extended `test_refinery_unclear_fallback_policy.sh` to cover merge-conflict auto-resolution before fallback merge failure handling.
- Witness/refinery stale-close hard-stop: re-sling now enforces a final dispatch-instant gate that aborts spawn when the linked issue is not `OPEN` or when the source PR is not `OPEN`/`MERGEABLE`.
- Re-sling stale/final-gate skip logging now records structured forensic fields including `source_event_key` and `skip_reason` (`RESLING_SKIP_STALE`, `RESLING_SKIP_FINAL_GATE`).
- Expanded stale replay regression coverage in `test_refinery_stale_post_merge_redispatch.sh` to reproduce a late `CLOSED`/`MERGED` event replay where stale pre-check passes but dispatch-instant gate blocks spawn.
- Refinery conflict path now persists durable per-issue evidence (`~/.sgt/refinery-conflicts/*.state`) with original PR/head/attempt/timestamp context (`ORIGIN_PR`, `ORIGIN_HEAD_SHA`, `ORIGIN_ATTEMPT_KEY`, `ORIGIN_TS`) before conflict close/re-sling side effects.
- Added a per-issue active re-sling claim fence (`~/.sgt/resling-issue-claims/`) so concurrent conflict handlers dedupe to one active re-sling action and emit structured telemetry (`REFINERY_CONFLICT_RESLING_DEDUPE`).
- Refinery restart replay now resumes pending conflict evidence from disk and marks successful replay dispatches (`REFINERY_CONFLICT_RESLING_RESUMED`) without spawning duplicate polecats.
- Added regression coverage for concurrent conflict dedupe plus restart replay resume in `test_refinery_conflict_resling_guardrail.sh` (wired into `test_mayor_wake_replay_regression.sh`).
- `sgt status` now guards terminal-width initialization for non-TTY/narrow environments, avoids nounset crashes in PR-title truncation, and always exits `0` after rendering.
- Added regression coverage for status rendering with unset/narrow `COLUMNS` in `test_status_non_tty_term_cols_guard.sh`.
