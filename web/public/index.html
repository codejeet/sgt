<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SGT Control Panel</title>
<style>
  :root {
    --bg: #ffffff;
    --bg2: #f5f5f5;
    --bg3: #ebebeb;
    --border: #000000;
    --border-light: #d0d0d0;
    --text: #000000;
    --text-dim: #666666;
    --accent: #e00;
    --green: #007a33;
    --red: #e00;
    --orange: #c45500;
    --purple: #6b3fa0;
    --unit: 8px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  a { color: var(--text); text-decoration: underline; }
  a:hover { color: var(--accent); }

  /* Header */
  .header {
    border-bottom: 2px solid var(--border);
    padding: 24px 40px;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
  }
  .header h1 {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text);
  }
  .header h1 span {
    color: var(--accent);
    font-size: 24px;
    letter-spacing: 0.05em;
    display: block;
    text-transform: none;
    margin-bottom: 2px;
  }
  .header .conn-status {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dim);
  }
  .header .conn-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--red);
    flex-shrink: 0;
  }
  .header .conn-dot.connected { background: var(--green); }

  /* Navigation */
  .nav {
    border-bottom: 1px solid var(--border-light);
    display: flex;
    gap: 0;
    overflow-x: auto;
    padding: 0 40px;
  }
  .nav button {
    background: none;
    border: none;
    color: var(--text-dim);
    padding: 14px 0;
    margin-right: 32px;
    font-family: inherit;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: color 0.15s;
  }
  .nav button:hover { color: var(--text); }
  .nav button.active {
    color: var(--text);
    border-bottom-color: var(--accent);
  }

  /* Main content */
  .main { padding: 40px; max-width: 1120px; }

  .panel { display: none; }
  .panel.active { display: block; }

  /* Cards */
  .card {
    background: var(--bg);
    border: 1px solid var(--border-light);
    margin-bottom: 32px;
    overflow: hidden;
  }
  .card-header {
    padding: 16px 20px;
    font-size: 10px;
    font-weight: 700;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .card-body { padding: 20px; }

  /* Status indicators */
  .status-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 8px;
    flex-shrink: 0;
  }
  .status-on { background: var(--green); }
  .status-off { background: var(--border-light); }
  .status-alive { background: var(--green); }
  .status-dead { background: var(--border-light); }

  /* Agent grid */
  .agent-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 16px;
  }
  .agent-item {
    border: 1px solid var(--border-light);
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .agent-item .name {
    font-weight: 600;
    font-size: 13px;
    flex: 1;
  }
  .agent-item .meta {
    color: var(--text-dim);
    font-size: 11px;
    text-align: right;
  }

  /* Worker lists */
  .worker-list { display: flex; flex-direction: column; gap: 0; }
  .worker-item {
    padding: 16px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.1s;
  }
  .worker-item:last-child { border-bottom: none; }
  .worker-item:hover { background: var(--bg2); }
  .worker-item .worker-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .worker-item .worker-name {
    font-weight: 600;
    font-size: 13px;
    font-family: 'SF Mono', 'Consolas', 'Liberation Mono', monospace;
    letter-spacing: -0.01em;
  }
  .worker-item .worker-meta {
    color: var(--text-dim);
    font-size: 12px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding-left: 16px;
  }
  .worker-item .worker-meta span { display: block; }
  .badge {
    font-size: 9px;
    padding: 2px 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .badge-alive {
    background: var(--green);
    color: #fff;
  }
  .badge-dead {
    background: var(--border-light);
    color: var(--text-dim);
  }
  .badge-running {
    background: var(--text);
    color: #fff;
  }

  /* Rig cards */
  .rig-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
  }
  .rig-card {
    border: 1px solid var(--border-light);
    padding: 20px;
  }
  .rig-card .rig-name {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .rig-card .rig-repo {
    color: var(--text-dim);
    font-size: 12px;
    margin-bottom: 16px;
    word-break: break-all;
  }
  .rig-card .rig-stats {
    display: flex;
    gap: 24px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .rig-card .rig-stats span { color: var(--text-dim); }
  .rig-card .rig-stats .val { color: var(--text); font-weight: 700; }

  /* Sling form */
  .sling-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 560px;
  }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text);
  }
  .form-group select,
  .form-group input,
  .form-group textarea {
    background: var(--bg);
    border: 1px solid var(--border-light);
    color: var(--text);
    padding: 10px 12px;
    font-family: inherit;
    font-size: 14px;
    transition: border-color 0.15s;
  }
  .form-group textarea { min-height: 100px; resize: vertical; }
  .form-group select:focus,
  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--text);
  }
  .form-row { display: flex; gap: 16px; }
  .form-row .form-group { flex: 1; }
  .btn {
    background: var(--text);
    color: #fff;
    border: none;
    padding: 10px 24px;
    font-family: inherit;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    align-self: flex-start;
    transition: background 0.15s;
  }
  .btn:hover { background: var(--accent); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn-secondary {
    background: var(--bg);
    border: 1px solid var(--border-light);
    color: var(--text);
  }
  .btn-secondary:hover { border-color: var(--text); background: var(--bg); }

  /* Log viewer */
  .log-viewer {
    background: var(--bg2);
    border: 1px solid var(--border-light);
    height: 500px;
    overflow-y: auto;
    padding: 16px;
    font-family: 'SF Mono', 'Consolas', 'Liberation Mono', monospace;
    font-size: 12px;
    line-height: 1.7;
  }
  .log-line { white-space: pre-wrap; word-break: break-all; }
  .log-line .timestamp { color: var(--text-dim); }
  .log-line .event { color: var(--accent); font-weight: 700; }

  /* Merge queue */
  .mq-list { display: flex; flex-direction: column; gap: 0; }
  .mq-item {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 1px solid var(--border-light);
  }
  .mq-item:last-child { border-bottom: none; }
  .mq-item .mq-pr { font-weight: 700; font-size: 13px; }
  .mq-item .mq-meta { color: var(--text-dim); font-size: 12px; flex: 1; }

  /* Peek modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg);
    border: 2px solid var(--border);
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .modal-header button {
    background: none;
    border: none;
    color: var(--text);
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
  }
  .modal-header button:hover { color: var(--accent); }
  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }
  .modal-body pre {
    white-space: pre-wrap;
    word-break: break-all;
    font-family: 'SF Mono', 'Consolas', 'Liberation Mono', monospace;
    font-size: 12px;
    line-height: 1.6;
  }

  /* Empty state */
  .empty {
    color: var(--text-dim);
    text-align: center;
    padding: 40px 24px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--text);
    color: #fff;
    padding: 12px 20px;
    font-size: 12px;
    font-weight: 500;
    max-width: 360px;
    animation: slideIn 0.2s ease-out;
  }
  .toast.error { background: var(--red); }
  .toast.success { background: var(--green); }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Section titles */
  .section-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-title .count {
    background: var(--text);
    color: #fff;
    padding: 2px 8px;
    font-size: 10px;
    font-weight: 700;
  }
</style>
</head>
<body>

<div class="header">
  <h1><span>SGT</span> Control Panel</h1>
  <div class="conn-status">
    <div class="conn-dot" id="connDot"></div>
    <span id="connLabel">Disconnected</span>
  </div>
</div>

<nav class="nav" id="nav">
  <button class="active" data-panel="dashboard">Dashboard</button>
  <button data-panel="polecats">Polecats</button>
  <button data-panel="dogs">Dogs</button>
  <button data-panel="rigs">Rigs</button>
  <button data-panel="sling">Sling</button>
  <button data-panel="logs">Logs</button>
  <button data-panel="merge-queue">Merge Queue</button>
</nav>

<div class="main">
  <!-- Dashboard -->
  <div class="panel active" id="panel-dashboard">
    <div class="card">
      <div class="card-header">Agents</div>
      <div class="card-body">
        <div class="agent-grid" id="agentGrid"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span>Polecats</span>
        <span class="count" id="polecatCount">0</span>
      </div>
      <div class="card-body" style="padding:0;">
        <div class="worker-list" id="dashPolecats"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span>Merge Queue</span>
        <span class="count" id="mqCount">0</span>
      </div>
      <div class="card-body" style="padding:0;">
        <div class="mq-list" id="dashMergeQueue"></div>
      </div>
    </div>
  </div>

  <!-- Polecats -->
  <div class="panel" id="panel-polecats">
    <div class="section-title">Active Polecats <span class="count" id="polecatCount2">0</span></div>
    <div class="worker-list" id="polecatList"></div>
  </div>

  <!-- Dogs -->
  <div class="panel" id="panel-dogs">
    <div class="section-title">Active Dogs <span class="count" id="dogCount">0</span></div>
    <div class="worker-list" id="dogList"></div>
  </div>

  <!-- Rigs -->
  <div class="panel" id="panel-rigs">
    <div class="section-title">Registered Rigs <span class="count" id="rigCount">0</span></div>
    <div class="rig-grid" id="rigGrid"></div>
  </div>

  <!-- Sling -->
  <div class="panel" id="panel-sling">
    <div class="card">
      <div class="card-header">Dispatch Polecat</div>
      <div class="card-body">
        <form class="sling-form" id="slingForm">
          <div class="form-group">
            <label>Rig</label>
            <select id="slingRig" required></select>
          </div>
          <div class="form-group">
            <label>Task Description</label>
            <textarea id="slingTask" placeholder="Describe the task..." required></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Labels (comma-separated)</label>
              <input type="text" id="slingLabels" placeholder="enhancement, bug...">
            </div>
            <div class="form-group">
              <label>Convoy (Milestone)</label>
              <input type="text" id="slingConvoy" placeholder="Optional milestone name">
            </div>
          </div>
          <button type="submit" class="btn" id="slingBtn">Sling Polecat</button>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="card-header">Dispatch Dog</div>
      <div class="card-body">
        <form class="sling-form" id="dogForm">
          <div class="form-group">
            <label>Rig</label>
            <select id="dogRig" required></select>
          </div>
          <div class="form-group">
            <label>Issue Number</label>
            <input type="text" id="dogIssue" placeholder="#7 or 7" required>
          </div>
          <button type="submit" class="btn" id="dogBtn">Sling Dog</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Logs -->
  <div class="panel" id="panel-logs">
    <div class="card">
      <div class="card-header">
        <span>sgt.log</span>
        <button class="btn btn-secondary" onclick="loadLogs()" style="padding:4px 12px;font-size:10px;">Refresh</button>
      </div>
      <div class="card-body" style="padding:0;">
        <div class="log-viewer" id="logViewer"></div>
      </div>
    </div>
  </div>

  <!-- Merge Queue -->
  <div class="panel" id="panel-merge-queue">
    <div class="section-title">Refinery Merge Queue <span class="count" id="mqCount2">0</span></div>
    <div class="mq-list" id="mergeQueueList"></div>
  </div>
</div>

<!-- Peek Modal -->
<div class="modal-overlay" id="peekModal">
  <div class="modal">
    <div class="modal-header">
      <span id="peekTitle">Peek</span>
      <button onclick="closePeek()">&times;</button>
    </div>
    <div class="modal-body">
      <pre id="peekOutput">Loading...</pre>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toasts"></div>

<script>
// --- State ---
let ws = null;
let state = { agents: [], polecats: [], dogs: [], crew: [], mergeQueue: [] };
let rigs = [];

// --- Nav ---
document.getElementById('nav').addEventListener('click', (e) => {
  if (e.target.tagName !== 'BUTTON') return;
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById('panel-' + e.target.dataset.panel).classList.add('active');

  if (e.target.dataset.panel === 'logs') loadLogs();
  if (e.target.dataset.panel === 'rigs') loadRigs();
});

// --- WebSocket ---
function connectWs() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host);

  ws.onopen = () => {
    document.getElementById('connDot').classList.add('connected');
    document.getElementById('connLabel').textContent = 'Connected';
  };

  ws.onclose = () => {
    document.getElementById('connDot').classList.remove('connected');
    document.getElementById('connLabel').textContent = 'Disconnected';
    setTimeout(connectWs, 3000);
  };

  ws.onerror = () => ws.close();

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'status') {
      state = msg.parsed;
      renderDashboard();
      renderPolecats();
      renderDogs();
      renderMergeQueue();
    } else if (msg.type === 'log') {
      appendLogLines(msg.lines);
    }
  };
}
connectWs();

// --- Render: Dashboard ---
function renderDashboard() {
  // Agents
  const grid = document.getElementById('agentGrid');
  grid.innerHTML = state.agents.map(a => {
    const isOn = a.status.startsWith('on');
    return `<div class="agent-item">
      <span class="status-dot ${isOn ? 'status-on' : 'status-off'}"></span>
      <span class="name">${esc(a.name)}</span>
      <span class="meta">${esc(a.status)}${a.heartbeat ? '<br>' + esc(a.heartbeat) : ''}</span>
    </div>`;
  }).join('');

  // Polecats summary
  document.getElementById('polecatCount').textContent = state.polecats.length;
  const dashP = document.getElementById('dashPolecats');
  if (state.polecats.length === 0) {
    dashP.innerHTML = '<div class="empty">No active polecats</div>';
  } else {
    dashP.innerHTML = state.polecats.map(p => workerHtml(p)).join('');
  }

  // Merge queue summary
  document.getElementById('mqCount').textContent = state.mergeQueue.length;
  const dashMq = document.getElementById('dashMergeQueue');
  if (state.mergeQueue.length === 0) {
    dashMq.innerHTML = '<div class="empty">Merge queue empty</div>';
  } else {
    dashMq.innerHTML = state.mergeQueue.map(m =>
      `<div class="mq-item">
        <span class="mq-pr">${esc(m.name)}</span>
        <span class="mq-meta">${esc(m.detail)}</span>
      </div>`
    ).join('');
  }
}

function workerHtml(p) {
  const isAlive = p.alive === 'alive';
  return `<div class="worker-item" onclick="peek('${esc(p.name)}')">
    <div class="worker-header">
      <span class="status-dot ${isAlive ? 'status-alive' : 'status-dead'}"></span>
      <span class="worker-name">${esc(p.name)}</span>
      <span class="badge ${isAlive ? 'badge-alive' : 'badge-dead'}">${isAlive ? 'alive' : 'dead'}</span>
    </div>
    <div class="worker-meta">
      ${p.rig ? '<span>rig: ' + esc(p.rig) + '</span>' : ''}
      ${p.issue ? '<span>issue: ' + esc(p.issue) + '</span>' : ''}
      ${p.branch ? '<span>branch: ' + esc(p.branch) + '</span>' : ''}
      ${p.pr ? '<span>pr: ' + esc(p.pr) + '</span>' : ''}
    </div>
  </div>`;
}

// --- Render: Polecats ---
function renderPolecats() {
  document.getElementById('polecatCount2').textContent = state.polecats.length;
  const list = document.getElementById('polecatList');
  if (state.polecats.length === 0) {
    list.innerHTML = '<div class="empty">No active polecats</div>';
  } else {
    list.innerHTML = state.polecats.map(p => workerHtml(p)).join('');
  }
}

// --- Render: Dogs ---
function renderDogs() {
  document.getElementById('dogCount').textContent = state.dogs.length;
  const list = document.getElementById('dogList');
  if (state.dogs.length === 0) {
    list.innerHTML = '<div class="empty">No active dogs</div>';
  } else {
    list.innerHTML = state.dogs.map(d =>
      `<div class="worker-item">
        <div class="worker-header">
          <span class="status-dot ${d.alive === 'alive' ? 'status-alive' : 'status-dead'}"></span>
          <span class="worker-name">${esc(d.name)}</span>
          <span class="badge ${d.alive === 'alive' ? 'badge-alive' : 'badge-dead'}">${d.alive}</span>
        </div>
        <div class="worker-meta"><span>${esc(d.issue)}</span></div>
      </div>`
    ).join('');
  }
}

// --- Render: Merge Queue ---
function renderMergeQueue() {
  document.getElementById('mqCount2').textContent = state.mergeQueue.length;
  const list = document.getElementById('mergeQueueList');
  if (state.mergeQueue.length === 0) {
    list.innerHTML = '<div class="empty">Merge queue empty</div>';
  } else {
    list.innerHTML = state.mergeQueue.map(m =>
      `<div class="mq-item">
        <span class="mq-pr">${esc(m.name)}</span>
        <span class="mq-meta">${esc(m.detail)}</span>
      </div>`
    ).join('');
  }
}

// --- Rigs ---
async function loadRigs() {
  try {
    const res = await fetch('/api/rigs');
    rigs = await res.json();
    renderRigs();
    populateRigSelects();
  } catch {}
}

function renderRigs() {
  document.getElementById('rigCount').textContent = rigs.length;
  const grid = document.getElementById('rigGrid');
  if (rigs.length === 0) {
    grid.innerHTML = '<div class="empty">No rigs registered</div>';
    return;
  }
  grid.innerHTML = rigs.map(r =>
    `<div class="rig-card">
      <div class="rig-name">${esc(r.name)}</div>
      <div class="rig-repo"><a href="${esc(r.repo)}" target="_blank">${esc(r.repo)}</a></div>
      <div class="rig-stats">
        <span>polecats: <span class="val">${r.polecats ?? '?'}</span></span>
        <span>witness: <span class="val">${esc(r.witness ?? '?')}</span></span>
        <span>refinery: <span class="val">${esc(r.refinery ?? '?')}</span></span>
      </div>
    </div>`
  ).join('');
}

function populateRigSelects() {
  const opts = rigs.map(r => `<option value="${esc(r.name)}">${esc(r.name)}</option>`).join('');
  const placeholder = '<option value="">Select a rig...</option>';
  document.getElementById('slingRig').innerHTML = placeholder + opts;
  document.getElementById('dogRig').innerHTML = placeholder + opts;
}

// Load rigs on start
loadRigs();

// --- Sling Form ---
document.getElementById('slingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('slingBtn');
  btn.disabled = true;
  btn.textContent = 'Dispatching...';
  try {
    const labels = document.getElementById('slingLabels').value
      .split(',').map(l => l.trim()).filter(Boolean);
    const res = await fetch('/api/sling', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        rig: document.getElementById('slingRig').value,
        task: document.getElementById('slingTask').value,
        labels,
        convoy: document.getElementById('slingConvoy').value || undefined,
      }),
    });
    const data = await res.json();
    if (res.ok) {
      toast('Polecat dispatched!', 'success');
      document.getElementById('slingTask').value = '';
      document.getElementById('slingLabels').value = '';
      document.getElementById('slingConvoy').value = '';
    } else {
      toast('Error: ' + data.error, 'error');
    }
  } catch (err) {
    toast('Error: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sling Polecat';
  }
});

document.getElementById('dogForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('dogBtn');
  btn.disabled = true;
  btn.textContent = 'Dispatching...';
  try {
    const issue = document.getElementById('dogIssue').value.replace('#', '');
    const res = await fetch('/api/sling-dog', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        rig: document.getElementById('dogRig').value,
        issue,
      }),
    });
    const data = await res.json();
    if (res.ok) {
      toast('Dog dispatched!', 'success');
      document.getElementById('dogIssue').value = '';
    } else {
      toast('Error: ' + data.error, 'error');
    }
  } catch (err) {
    toast('Error: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sling Dog';
  }
});

// --- Logs ---
async function loadLogs() {
  try {
    const res = await fetch('/api/logs?lines=200');
    const data = await res.json();
    const viewer = document.getElementById('logViewer');
    viewer.innerHTML = data.lines.map(formatLogLine).join('');
    viewer.scrollTop = viewer.scrollHeight;
  } catch {}
}

function appendLogLines(lines) {
  const viewer = document.getElementById('logViewer');
  const wasAtBottom = viewer.scrollHeight - viewer.scrollTop - viewer.clientHeight < 50;
  viewer.innerHTML += lines.map(formatLogLine).join('');
  if (wasAtBottom) viewer.scrollTop = viewer.scrollHeight;
}

function formatLogLine(line) {
  const m = line.match(/^\[([^\]]+)\]\s+(\S+)\s*(.*)/);
  if (m) {
    return `<div class="log-line"><span class="timestamp">[${esc(m[1])}]</span> <span class="event">${esc(m[2])}</span> ${esc(m[3])}</div>`;
  }
  return `<div class="log-line">${esc(line)}</div>`;
}

// --- Peek ---
async function peek(target) {
  document.getElementById('peekModal').classList.add('active');
  document.getElementById('peekTitle').textContent = 'Peek: ' + target;
  document.getElementById('peekOutput').textContent = 'Loading...';
  try {
    const res = await fetch('/api/peek/' + encodeURIComponent(target));
    const data = await res.json();
    document.getElementById('peekOutput').textContent = data.output || data.error || 'No output';
  } catch (err) {
    document.getElementById('peekOutput').textContent = 'Error: ' + err.message;
  }
}

function closePeek() {
  document.getElementById('peekModal').classList.remove('active');
}

document.getElementById('peekModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closePeek();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closePeek();
});

// --- Toast ---
function toast(msg, type) {
  const container = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast ' + (type || '');
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// --- Util ---
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}
</script>
</body>
</html>
